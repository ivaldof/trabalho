# Guia Detalhado: Configura√ß√£o Samba AD - Servidor e Cliente

## üñ•Ô∏è CEN√ÅRIO DO TRABALHO

**Voc√™ tem:**
- **SERVIDOR** Ubuntu Server (192.168.10.2) - Samba AD j√° configurado ‚úÖ
- **CLIENTE** Ubuntu Desktop (192.168.10.4) - Precisa configurar ‚ùå

**Objetivo:** Fazer o cliente ingressar no dom√≠nio e criar usu√°rios/compartilhamentos

---

# üîß PARTE 1: CONFIGURA√á√ïES NO SERVIDOR (192.168.10.2)

> **ONDE:** Acesse o servidor Ubuntu Server em 192.168.10.2
> **COMO:** Via SSH `ssh ivaldo@192.168.10.2` ou diretamente no servidor

## Passo S1: Criar Grupos no Servidor

```bash
# Entrar no servidor
ssh ivaldo@192.168.10.2

# Criar os 2 grupos solicitados
sudo samba-tool group add vendas
sudo samba-tool group add administracao

# Verificar se foram criados
sudo samba-tool group list | grep -E "(vendas|administracao)"
```

**‚úÖ Resultado esperado:**
```
vendas
administracao
```

## Passo S2: Criar Usu√°rios no Servidor

```bash
# Criar os 4 usu√°rios solicitados
sudo samba-tool user create joao --given-name="Jo√£o" --surname="Silva"
# Vai pedir senha - ANOTE A SENHA!

sudo samba-tool user create maria --given-name="Maria" --surname="Santos"
# Vai pedir senha - ANOTE A SENHA!

sudo samba-tool user create pedro --given-name="Pedro" --surname="Costa"  
# Vai pedir senha - ANOTE A SENHA!

sudo samba-tool user create ana --given-name="Ana" --surname="Oliveira"
# Vai pedir senha - ANOTE A SENHA!

# Verificar se foram criados
sudo samba-tool user list | grep -E "(joao|maria|pedro|ana)"
```

**üìù IMPORTANTE:** Anote as senhas que voc√™ criar para cada usu√°rio!

## Passo S3: Associar Usu√°rios aos Grupos

```bash
# Grupo VENDAS: Jo√£o e Maria
sudo samba-tool group addmembers vendas joao,maria

# Grupo ADMINISTRA√á√ÉO: Pedro e Ana  
sudo samba-tool group addmembers administracao pedro,ana

# Jo√£o tamb√©m vai para ADMINISTRA√á√ÉO (ele fica nos 2 grupos)
sudo samba-tool group addmembers administracao joao

# VERIFICAR as associa√ß√µes
echo "=== MEMBROS DO GRUPO VENDAS ==="
sudo samba-tool group listmembers vendas

echo "=== MEMBROS DO GRUPO ADMINISTRA√á√ÉO ==="
sudo samba-tool group listmembers administracao
```

**‚úÖ Resultado esperado:**
- **Vendas:** joao, maria
- **Administra√ß√£o:** pedro, ana, joao

## Passo S4: Criar Diret√≥rios para Compartilhamento

```bash
# Criar diret√≥rios
sudo mkdir -p /samba/publico
sudo mkdir -p /samba/vendas-apenas
sudo mkdir -p /samba/admin-apenas

# Definir propriet√°rios dos diret√≥rios
sudo chown -R root:"domain users" /samba/publico
sudo chown -R root:vendas /samba/vendas-apenas
sudo chown -R root:administracao /samba/admin-apenas

# Definir permiss√µes
sudo chmod -R 2775 /samba/

# Verificar se foram criados
ls -la /samba/
```

## Passo S5: Configurar Compartilhamentos no Samba

```bash
# Fazer backup da configura√ß√£o atual
sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.backup

# Editar arquivo de configura√ß√£o
sudo nano /etc/samba/smb.conf
```

**üìù ADICIONE estas se√ß√µes NO FINAL do arquivo:**

```ini
[publico]
    path = /samba/publico
    browseable = yes
    read only = no
    valid users = @"domain users"
    create mask = 0664
    directory mask = 2775
    comment = Acesso para todos os usuarios do dominio

[vendas-apenas]
    path = /samba/vendas-apenas
    browseable = yes
    read only = no
    valid users = @vendas
    create mask = 0664
    directory mask = 2775
    comment = Acesso apenas para o grupo vendas

[admin-apenas]
    path = /samba/admin-apenas
    browseable = yes
    read only = no
    valid users = @administracao
    create mask = 0664
    directory mask = 2775
    comment = Acesso apenas para o grupo administracao
```

```bash
# Salvar e sair (Ctrl+X, Y, Enter)

# Testar configura√ß√£o
testparm

# Reiniciar Samba
sudo systemctl restart samba-ad-dc

# Verificar se est√° rodando
sudo systemctl status samba-ad-dc
```

**‚úÖ O servidor est√° configurado!**

---

# üíª PARTE 2: CONFIGURA√á√ïES NO CLIENTE (192.168.10.4)

> **ONDE:** Acesse o cliente Ubuntu Desktop em 192.168.10.4
> **COMO:** Diretamente na m√°quina cliente

## Passo C1: Configurar Rede do Cliente

```bash
# Verificar interfaces de rede
ip -br a
```

**üìù Voc√™ ver√° algo como:**
```
lo               UNKNOWN        127.0.0.1/8
enp0s3           UP             192.168.1.100/24  
enp0s8           DOWN           (esta √© a que vamos configurar)
```

```bash
# Configurar rede
sudo nano /etc/netplan/01-netcfg.yaml
```

**üîÑ SUBSTITUA todo o conte√∫do por:**
```yaml
network:
  version: 2
  ethernets:
    enp0s3:
      dhcp4: true
    enp0s8:
      addresses: [192.168.10.4/24]
      nameservers:
        addresses: [192.168.10.2, 8.8.8.8]
        search: [samba.local]
```

```bash
# Aplicar configura√ß√£o
sudo netplan apply

# Verificar se funcionou  
ip -br a | grep 192.168.10.4
```

**‚úÖ Deve mostrar:** `enp0s8 UP 192.168.10.4/24`

## Passo C2: Configurar Nome da M√°quina Cliente

```bash
# Definir hostname
sudo hostnamectl set-hostname cliente-ubuntu

# Verificar
hostname
```

```bash
# Configurar arquivo hosts
sudo nano /etc/hosts
```

**üîÑ SUBSTITUA todo o conte√∫do por:**
```
127.0.0.1    localhost
127.0.1.1    cliente-ubuntu  
192.168.10.2  dc.samba.local dc samba.local

::1      ip6-localhost ip6-loopback
fe00::0  ip6-localnet
ff00::0  ip6-mcastprefix
ff02::1  ip6-allnodes
ff02::2  ip6-allrouters
```

## Passo C3: Configurar DNS do Cliente

```bash
# Parar servi√ßo systemd-resolved
sudo systemctl disable --now systemd-resolved

# Remover link simb√≥lico
sudo unlink /etc/resolv.conf

# Criar arquivo DNS manual
sudo nano /etc/resolv.conf
```

**üìù CONTE√öDO do arquivo:**
```
nameserver 192.168.10.2
nameserver 8.8.8.8
search samba.local
```

```bash
# Proteger arquivo
sudo chattr +i /etc/resolv.conf

# TESTAR conectividade com servidor
ping -c3 192.168.10.2
ping -c3 samba.local
```

**‚úÖ Se o ping funcionar, continue!**

## Passo C4: Instalar Pacotes para Dom√≠nio

```bash
# Atualizar reposit√≥rios
sudo apt-get update

# Instalar pacotes necess√°rios
sudo apt install -y realmd sssd sssd-tools libnss-sss libpam-sss adcli samba-common-bin packagekit krb5-user
```

**üîî DURANTE A INSTALA√á√ÉO, responda:**
- **Realm padr√£o Kerberos:** `SAMBA.LOCAL`
- **Servidor Kerberos:** `dc.samba.local`
- **Servidor administrativo:** `dc.samba.local`

## Passo C5: Ingressar no Dom√≠nio

```bash
# Descobrir o dom√≠nio
realm discover samba.local
```

**‚úÖ Deve mostrar algo como:**
```
samba.local
  type: kerberos
  realm-name: SAMBA.LOCAL
  domain-name: samba.local
  configured: no
  server-software: active-directory
```

```bash
# Ingressar no dom√≠nio
sudo realm join --user=administrator samba.local
```

**üîë Digite a senha do administrator do servidor**

```bash
# Verificar se ingressou
realm list
```

**‚úÖ Deve mostrar:** `configured: kerberos-member`

## Passo C6: Configurar Sistema para Usu√°rios do Dom√≠nio

```bash
# Permitir cria√ß√£o autom√°tica de home
sudo pam-auth-update --enable mkhomedir

# Reiniciar SSSD
sudo systemctl restart sssd
sudo systemctl enable sssd

# Verificar status
sudo systemctl status sssd
```

## Passo C7: Testar Usu√°rios do Dom√≠nio

```bash
# Testar se consegue ver usu√°rios do servidor
getent passwd joao
getent passwd maria  
getent passwd pedro
getent passwd ana

# Testar informa√ß√µes de grupo do Jo√£o (deve estar nos 2 grupos)
id joao
```

**‚úÖ Resultado esperado para `id joao`:**
```
uid=xxxxx(joao) gid=xxxxx(domain users) groups=xxxxx(domain users),xxxxx(vendas),xxxxx(administracao)
```

## Passo C8: Testar Login com Usu√°rio do Dom√≠nio

```bash
# Testar login via SSH
ssh joao@localhost
# Digite a senha do joao

# Verificar diret√≥rio home foi criado
ls /home/
```

**üñ•Ô∏è TAMB√âM pode fazer logout da interface gr√°fica e login com:**
- **Usu√°rio:** `joao`
- **Senha:** (senha que voc√™ definiu)

---

# üìÅ PARTE 3: TESTAR COMPARTILHAMENTOS

> **ONDE:** No cliente Ubuntu Desktop (192.168.10.4)

## Passo T1: Instalar Utilit√°rios de Rede

```bash
# Instalar smbclient
sudo apt install cifs-utils smbclient
```

## Passo T2: Testar Acesso aos Compartilhamentos

```bash
# TESTE 1: Jo√£o (deve acessar TODOS os compartilhamentos)
echo "=== TESTE COM JO√ÉO (todos os compartilhamentos) ==="
smbclient //192.168.10.2/publico -U joao
# Digite senha, depois: ls, quit

smbclient //192.168.10.2/vendas-apenas -U joao
# Digite senha, depois: ls, quit

smbclient //192.168.10.2/admin-apenas -U joao  
# Digite senha, depois: ls, quit

echo "‚úÖ Jo√£o deve conseguir acessar todos!"
```

```bash
# TESTE 2: Maria (s√≥ p√∫blico e vendas)
echo "=== TESTE COM MARIA (p√∫blico e vendas apenas) ==="
smbclient //192.168.10.2/publico -U maria
# Digite senha, depois: ls, quit

smbclient //192.168.10.2/vendas-apenas -U maria
# Digite senha, depois: ls, quit

smbclient //192.168.10.2/admin-apenas -U maria
# Deve DAR ERRO de acesso negado ‚ùå

echo "‚úÖ Maria deve acessar p√∫blico e vendas, mas N√ÉO admin!"
```

```bash
# TESTE 3: Pedro (s√≥ p√∫blico e admin)
echo "=== TESTE COM PEDRO (p√∫blico e admin apenas) ==="
smbclient //192.168.10.2/publico -U pedro
# Digite senha, depois: ls, quit

smbclient //192.168.10.2/admin-apenas -U pedro
# Digite senha, depois: ls, quit

smbclient //192.168.10.2/vendas-apenas -U pedro  
# Deve DAR ERRO de acesso negado ‚ùå

echo "‚úÖ Pedro deve acessar p√∫blico e admin, mas N√ÉO vendas!"
```

---

# ‚úÖ CHECKLIST FINAL - TRABALHO COMPLETO

## No Servidor (192.168.10.2):
- [x] ‚úÖ Criados 2 grupos: `vendas` e `administracao`
- [x] ‚úÖ Criados 4 usu√°rios: `joao`, `maria`, `pedro`, `ana` 
- [x] ‚úÖ Jo√£o pertence a 2 grupos (vendas + administracao)
- [x] ‚úÖ Criados 3 compartilhamentos com permiss√µes diferentes
- [x] ‚úÖ Configura√ß√£o do Samba funcionando

## No Cliente (192.168.10.4):
- [x] ‚úÖ Rede configurada (192.168.10.4/24)
- [x] ‚úÖ DNS apontando para servidor (192.168.10.2)
- [x] ‚úÖ Cliente ingressado no dom√≠nio SAMBA.LOCAL
- [x] ‚úÖ Login funcionando com usu√°rios do dom√≠nio
- [x] ‚úÖ Acesso aos compartilhamentos testado

## Atividades Obrigat√≥rias:
1. ‚úÖ **Ingressar cliente no dom√≠nio:** Feito via `realm join`
2. ‚úÖ **Criar 4 usu√°rios e 2 grupos:** joao, maria, pedro, ana + vendas, administracao  
3. ‚úÖ **Usu√°rio em 2 grupos:** Jo√£o est√° em vendas E administracao
4. ‚úÖ **Login no cliente:** Testado com usu√°rios do dom√≠nio
5. ‚úÖ **Compartilhamentos com permiss√µes:** 3 compartilhamentos diferentes
6. ‚úÖ **Testar acessos:** Validado que permiss√µes funcionam

---

# üö® COMANDOS DE VERIFICA√á√ÉO R√ÅPIDA

## Verificar no Servidor:
```bash
# Usu√°rios e grupos
sudo samba-tool user list | grep -E "(joao|maria|pedro|ana)"
sudo samba-tool group listmembers vendas
sudo samba-tool group listmembers administracao

# Servi√ßo funcionando
sudo systemctl status samba-ad-dc
```

## Verificar no Cliente:
```bash
# Dom√≠nio
realm list

# Usu√°rios do dom√≠nio
getent passwd joao maria pedro ana

# Grupos do Jo√£o
id joao
```

**üéâ TRABALHO COMPLETO!** Todas as atividades obrigat√≥rias foram executadas!
